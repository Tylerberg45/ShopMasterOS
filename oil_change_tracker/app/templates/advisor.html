
{% extends "layout.html" %}
{% block content %}
<div class="mb-4">
  <h2 class="mb-1">AI Advisor <span class="badge bg-secondary">Preview</span></h2>
  <div class="muted mb-2">This page summarizes usage and offers suggestions. Click <strong>Generate Report</strong> to save a shareable report you can send to ChatGPT for deeper analysis.</div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h4 class="card-title">Metrics (last 30 days)</h4>
    <ul class="mb-2">
      <li>Total searches: <strong>{{ metrics.search_total }}</strong> (no result: {{ metrics.search_no_result }} → {{ (metrics.search_no_result_rate*100)|round(0) }}%)</li>
      <li>Oil change deducts: <strong>{{ metrics.deducts }}</strong>, restores: <strong>{{ metrics.restores }}</strong> (restore ratio: {{ (metrics.restore_ratio*100)|round(0) }}%)</li>
      <li>Vehicles added: <strong>{{ metrics.vehicles_added }}</strong></li>
    </ul>
    {% if metrics.top_search_terms %}
      <h6 class="mt-3">Top search terms</h6>
      <ol class="mb-2">
        {% for term, cnt in metrics.top_search_terms %}
        <li>{{ term }} — {{ cnt }}</li>
        {% endfor %}
      </ol>
    {% endif %}
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h4 class="card-title">Suggestions</h4>
    <ul>
      {% for t in tips %}
      <li>{{ t }}</li>
      {% endfor %}
    </ul>
  </div>
</div>

{% if request.query_params.generated %}
<div class="alert alert-success d-flex justify-content-between align-items-center">
  <div>
    Advisor report generated for {{ request.query_params.date }}.
    <a href="/reports/{{ request.query_params.html }}" target="_blank">Open HTML</a> ·
    <a href="/reports/{{ request.query_params.json }}" target="_blank">JSON</a>
  </div>
  <a class="btn-close" href="/advisor" aria-label="Close"></a>
</div>
{% endif %}
<form id="advisorRunForm" method="post" action="/advisor/run" class="mb-3">
  <button class="btn btn-primary" type="submit" id="advisorRunBtn">Generate Report</button>
  <span id="advisorSpinner" class="ms-2" style="display:none;">Generating…</span>
</form>
<div class="small text-muted mb-2">Reports are accessible at <code>/reports/</code>. They overwrite daily.</div>
<script>
// Progressive enhancement: capture submit to use fetch so we stay on page without redirect flash
document.getElementById('advisorRunForm').addEventListener('submit', async function(ev){
  ev.preventDefault();
  const btn = document.getElementById('advisorRunBtn');
  const spin = document.getElementById('advisorSpinner');
  btn.disabled = true; spin.style.display='inline';
  try {
    const resp = await fetch('/advisor/run', {method:'POST', headers:{'accept':'application/json'}});
    const data = await resp.json();
    if(data.ok){
      // Build alert
      const params = new URLSearchParams({generated:'1', date: new Date().toISOString().slice(0,10), html: data.html_report.split('/').pop(), json: data.json_report.split('/').pop()});
      window.location = '/advisor?' + params.toString();
    } else {
      alert('Failed to generate report');
    }
  } catch(e){
    console.error(e);
    alert('Error generating report');
  } finally {
    btn.disabled = false; spin.style.display='none';
  }
});
</script>
{% endblock %}
