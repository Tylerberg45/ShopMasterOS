~
{% extends "layout.html" %}
{% block content %}
<div class="mb-4">
  <h2 class="mb-1">{{ c.first_name }} {{ c.last_name }}</h2>
  <div class="muted mb-2">Phone: {{ c.phone }}</div>
</div>

  <div class="card mb-4">
  <div class="card-body">
    <h4 class="card-title">Free Oil Changes</h4>
    {% if plan %}
      <div class="mb-3">
        <span class="pill">Remaining: {{ plan.remaining }}</span>
        <form method="post" action="/ui/customer/{{ c.id }}/add-four" class="d-inline ms-3">
          <button class="btn btn-success" type="button" onclick="promptAddOilChanges()">Add Oil Changes</button>
        </form>
        <button class="btn btn-outline-primary ms-2" onclick="openEditPlan({{ plan.remaining }})">Edit Free Oil Changes</button>
      </div>
    {% else %}
      <div class="text-danger">No active free oil changes.</div>
    {% endif %}
  </div>
</div>

<div class="mb-4">
  <h4>Vehicles</h4>
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Plate</th><th>VIN</th>
        <th>Year</th><th>Make</th><th>Model</th>
        <th>Default Oil</th>
        <th>Oil Changes Used</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for v in vehicles %}
      <tr>
        <td>{{ v.plate }}</td>
        <td>{{ v.vin }}</td>
        <td>{{ v.year }}</td>
        <td>{{ v.make }}</td>
        <td>{{ v.model }}</td>
        <td>
          {% if v.oil_weight %}{{ v.oil_weight }}{% endif %}
          {% if v.oil_capacity_quarts %} ({{ v.oil_capacity_quarts }} qt){% endif %}
        </td>
        <td>{{ vehicle_oil_changes[v.id] }}</td>
        <td>
          <div class="d-flex gap-1">
      {# Use data-* attributes to avoid inline JS errors when last mileage is None and to prevent quote escaping issues #}
      <button class="btn btn-warning btn-sm flex-fill"
        data-vehicle-id="{{ v.id }}"
        data-vehicle-info="{{ v.year }} {{ v.make }} {{ v.model }}"
        data-last-mileage="{{ vehicle_last_mileage[v.id]|default(0, true) }}"
        onclick="openUseOilChangeModal(this.dataset.vehicleId, this.dataset.vehicleInfo, parseInt(this.dataset.lastMileage || '0'))"
        title="Use 1 oil change - requires mileage">Use 1</button>
            <button class="btn btn-success btn-sm flex-fill" onclick="openAddFourModal({{ v.id }}, '{{ v.year }} {{ v.make }} {{ v.model }}')" 
                    title="Add 4 oil changes for tire purchase">Add 4</button>
          </div>
          
          <div class="mt-1">
            <button class="btn btn-outline-primary btn-sm w-100" onclick="openEditVehicle({{ v.id }}, '{{ v.plate }}', '{{ v.vin }}', '{{ v.year }}', '{{ v.make }}', '{{ v.model }}', '{{ v.oil_weight }}', '{{ v.oil_capacity_quarts }}')">Edit Vehicle</button>
          </div>
          {% if request.query_params.error %}
          <div class="text-danger mt-1">{{ request.query_params.error }}</div>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Add Vehicle</h5>
    <form method="post" action="/ui/customer/{{ c.id }}/vehicle" class="row g-2 align-items-end">
      <div class="col-md-2"><input name="plate" class="form-control" placeholder="License plate"></div>
      <div class="col-md-2">
        <div class="input-group">
          <input name="vin" id="addVin" class="form-control" placeholder="VIN (optional)">
          <button class="btn btn-outline-secondary" type="button" onclick="lookupVinForAdd()">üîç</button>
        </div>
      </div>
      <div class="col-md-2"><input name="year" id="addYear" class="form-control" placeholder="Year"></div>
      <div class="col-md-2"><input name="make" id="addMake" class="form-control" placeholder="Make"></div>
      <div class="col-md-2"><input name="model" id="addModel" class="form-control" placeholder="Model"></div>
      <div class="col-md-2 d-grid"><button class="btn btn-primary" type="submit">Add</button></div>
    </form>
    <div class="muted mt-2">Enter vehicle details manually or use VIN lookup (üîç) to auto-populate.</div>
  </div>
</div>

<div class="mb-4">
  <h4>History</h4>
  <table class="table table-bordered table-sm">
    <thead>
      <tr><th>Date</th><th>Change</th><th>Vehicle</th><th>Mileage</th><th>Note</th><th>Action</th></tr>
    </thead>
    <tbody>
    {% for e in ledger %}
      <tr id="ledger_row_{{ e.id }}" data-entry-id="{{ e.id }}">
        <td class="ledger-date" data-value="{{ e.created_at.strftime('%Y-%m-%d') if e.created_at }}">{{ e.service_date.strftime('%m/%d/%Y') if e.service_date else (e.created_at.strftime('%m/%d/%Y') if e.created_at else 'N/A') }}</td>
        <td class="ledger-delta">{{ e.delta }}</td>
        <td class="ledger-vehicle">
          {% if e.vehicle_id %}
            {% for v in vehicles %}
              {% if v.id == e.vehicle_id %}
                {{ v.year }} {{ v.make }} {{ v.model }}{% if v.plate %} ({{ v.plate }}){% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </td>
        <td class="ledger-mileage" data-value="{{ e.mileage if e.mileage }}">{% if e.mileage %}{{ e.mileage }}{% endif %}</td>
        <td class="ledger-note" data-value="{{ e.note }}">{{ e.note }}</td>
        <td class="ledger-actions">
          <button type="button" class="btn btn-outline-secondary btn-sm me-1 ledger-edit-btn" data-entry-id="{{ e.id }}">Edit</button>
          <form method="post" action="/ui/customer/{{ c.id }}/ledger/{{ e.id }}/delete" class="d-inline" onsubmit="return confirm('Are you sure you want to remove this entry? This will {% if e.delta < 0 %}add back{% else %}remove{% endif %} {{ e.delta|abs }} oil change{% if (e.delta|abs) != 1 %}s{% endif %}.')">
            <button type="submit" class="btn btn-danger btn-sm">
              <i class="bi bi-trash"></i>
            </button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- Edit Vehicle Modal -->
<div class="modal fade" id="editVehicleModal" tabindex="-1" aria-labelledby="editVehicleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editVehicleModalLabel">Edit Vehicle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editVehicleForm" method="post">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editPlate" class="form-label">License Plate</label>
            <input type="text" class="form-control" id="editPlate" name="plate">
          </div>
          <div class="mb-3">
            <label for="editVin" class="form-label">VIN</label>
            <div class="input-group">
              <input type="text" class="form-control" id="editVin" name="vin">
              <button class="btn btn-outline-secondary" type="button" onclick="lookupVinForEdit()">üîç Lookup</button>
            </div>
          </div>
          <div class="mb-3">
            <label for="editYear" class="form-label">Year</label>
            <input type="text" class="form-control" id="editYear" name="year">
          </div>
          <div class="mb-3">
            <label for="editMake" class="form-label">Make</label>
            <input type="text" class="form-control" id="editMake" name="make">
          </div>
          <div class="mb-3">
            <label for="editModel" class="form-label">Model</label>
            <input type="text" class="form-control" id="editModel" name="model">
          </div>
          <div class="mb-3">
            <label for="editOilWeight" class="form-label">Default Oil Weight</label>
            <input type="text" class="form-control" id="editOilWeight" name="oil_weight" placeholder="e.g., 5W-30">
          </div>
          <div class="mb-3">
            <label for="editOilCapacity" class="form-label">Default Oil Capacity (Quarts)</label>
            <input type="number" step="0.1" class="form-control" id="editOilCapacity" name="oil_capacity_quarts" placeholder="e.g., 5.5">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Oil Changes Modal -->
<div class="modal fade" id="addOilChangesModal" tabindex="-1" aria-labelledby="addOilChangesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addOilChangesModalLabel">Add Free Oil Changes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addOilChangesForm" method="post" action="/ui/customer/{{ c.id }}/add-oil-changes">
        <div class="modal-body">
          <div class="mb-3">
            <label for="addQuantity" class="form-label">Number of Oil Changes to Add</label>
            <input type="number" class="form-control" id="addQuantity" name="quantity" min="1" value="4" required>
          </div>
          <div class="mb-3">
            <label for="addReason" class="form-label">Reason</label>
            <textarea class="form-control" id="addReason" name="reason" rows="3" placeholder="e.g., Customer satisfaction - oil filter came loose on 2024 Honda Civic" required></textarea>
            <div class="form-text">Explain why these free oil changes are being added</div>
          </div>
          <div class="mb-3">
            <label for="addServiceDate" class="form-label">Service Date</label>
            <input type="date" class="form-control" id="addServiceDate" name="service_date" value="{{ today_date }}">
            <div class="form-text">Defaults to today's date - change if backdating</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Oil Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Plan Modal -->
<div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPlanModalLabel">Edit Free Oil Changes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editPlanForm" method="post" action="/ui/customer/{{ c.id }}/edit-plan">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editRemaining" class="form-label">Remaining Oil Changes</label>
            <input type="number" class="form-control" id="editRemaining" name="remaining" required>
            <div class="form-text">Can be negative if customer owes oil changes</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="errorModalLabel">Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="errorModalBody">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Mileage Confirmation Modal -->
<div class="modal fade" id="mileageConfirmModal" tabindex="-1" aria-labelledby="mileageConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="mileageConfirmModalLabel">‚ö†Ô∏è Mileage Warning</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="mileageConfirmModalBody">
        <!-- Warning message will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmMileageBtn" onclick="confirmMileage()">
          Confirm Mileage
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Use Oil Change Modal -->
<div class="modal fade" id="useOilChangeModal" tabindex="-1" aria-labelledby="useOilChangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="useOilChangeModalLabel">Use Oil Change</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="useOilChangeForm" method="post" action="/ui/customer/{{ c.id }}/deduct">
        <div class="modal-body">
          <div class="mb-3">
            <label for="useVehicleInfo" class="form-label">Vehicle</label>
            <input type="text" class="form-control" id="useVehicleInfo" readonly>
            <input type="hidden" id="useVehicleId" name="vehicle_id">
          </div>
          <div class="mb-3">
            <label for="useMileage" class="form-label">Current Mileage</label>
            <input type="number" class="form-control" id="useMileage" name="mileage" required 
                   oninput="if(this.value.length > 7) this.value = this.value.slice(0,7); validateMileage(this);">
            <div id="mileageWarning" class="form-text text-warning" style="display: none;">
              ‚ö†Ô∏è This mileage is less than the previous entry. Please double-check.
            </div>
          </div>
          <div class="mb-3">
            <label for="useServiceDate" class="form-label">Service Date</label>
            <input type="date" class="form-control" id="useServiceDate" name="service_date" value="{{ today_date }}">
            <div class="form-text">Defaults to today's date - change if backdating</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Use Oil Change</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Four Modal -->
<div class="modal fade" id="addFourModal" tabindex="-1" aria-labelledby="addFourModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addFourModalLabel">Add 4 Oil Changes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addFourForm" method="post" action="/ui/customer/{{ c.id }}/add-four">
        <div class="modal-body">
          <div class="mb-3">
            <label for="addFourVehicleInfo" class="form-label">Vehicle</label>
            <input type="text" class="form-control" id="addFourVehicleInfo" readonly>
            <input type="hidden" id="addFourVehicleId" name="vehicle_id">
          </div>
          <div class="mb-3">
            <label for="addFourServiceDate" class="form-label">Service Date</label>
            <input type="date" class="form-control" id="addFourServiceDate" name="service_date" value="{{ today_date }}">
            <div class="form-text">Defaults to today's date - change if backdating</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add 4 Oil Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Ledger Edit Modal
// Modal markup injected near end to avoid large restructures
</script>

<!-- Edit Ledger Entry Modal -->
<div class="modal fade" id="editLedgerModal" tabindex="-1" aria-labelledby="editLedgerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editLedgerModalLabel">Edit Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editLedgerForm" method="post">
        <div class="modal-body">
          <input type="hidden" name="entry_id" id="editLedgerEntryId">
          <div class="mb-3">
            <label class="form-label">Mileage</label>
            <input type="number" class="form-control" name="mileage" id="editLedgerMileage" placeholder="(leave blank to keep)" >
          </div>
          <div class="mb-3">
            <label class="form-label">Service Date</label>
            <input type="date" class="form-control" name="service_date" id="editLedgerDate">
          </div>
          <div class="mb-3">
            <label class="form-label">Oil Weight</label>
            <input type="text" class="form-control" name="oil_weight" id="editLedgerOilWeight" maxlength="10">
          </div>
          <div class="mb-3">
            <label class="form-label">Oil Quarts</label>
            <input type="number" step="0.1" class="form-control" name="oil_quarts" id="editLedgerOilQuarts">
          </div>
          <div class="mb-3">
            <label class="form-label">Note</label>
            <input type="text" class="form-control" name="note" id="editLedgerNote" maxlength="255">
          </div>
          <div class="small text-muted">Only change fields you want to update.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
async function openEditLedgerModal(entryId) {
  try {
    const resp = await fetch(`/ui/customer/{{ c.id }}/ledger/${entryId}/json`);
    const data = await resp.json();
    if (data.error) {
      alert('Entry not found');
      return;
    }
    document.getElementById('editLedgerForm').action = `/ui/customer/{{ c.id }}/ledger/${entryId}/edit`;
    document.getElementById('editLedgerEntryId').value = entryId;
    document.getElementById('editLedgerMileage').value = data.mileage ?? '';
    document.getElementById('editLedgerDate').value = data.date ?? '';
    document.getElementById('editLedgerOilWeight').value = data.oil_weight ?? '';
    document.getElementById('editLedgerOilQuarts').value = data.oil_quarts ?? '';
    document.getElementById('editLedgerNote').value = data.note ?? '';
    const modal = new bootstrap.Modal(document.getElementById('editLedgerModal'));
    modal.show();
  } catch (e) {
    console.error(e);
    alert('Failed to load entry');
  }
}

document.getElementById('editLedgerForm')?.addEventListener('submit', function() {
  // simple client-side trim
  const note = document.getElementById('editLedgerNote');
  note.value = note.value.trim();
});
</script>
function validateDeductForm(form) {
    const vehicle = form.vehicle_id.value;
    const mileage = form.mileage.value;
    if (!vehicle || !mileage) {
        alert('Please select a vehicle and enter the current mileage.');
        return false;
    }
    return confirm('Deduct one oil change for the selected vehicle?');
}

function openEditVehicle(id, plate, vin, year, make, model, oilWeight, oilCapacity) {
    const modal = new bootstrap.Modal(document.getElementById('editVehicleModal'));
    const form = document.getElementById('editVehicleForm');
    
    // Set form action
    form.action = `/vehicles/${id}/update`;
    
    // Fill in the form fields
    document.getElementById('editPlate').value = plate;
    document.getElementById('editVin').value = vin;
    document.getElementById('editYear').value = year;
    document.getElementById('editMake').value = make;
    document.getElementById('editModel').value = model;
    document.getElementById('editOilWeight').value = oilWeight;
    document.getElementById('editOilCapacity').value = oilCapacity;
    
    modal.show();
}

function openEditPlan(remaining) {
    const modal = new bootstrap.Modal(document.getElementById('editPlanModal'));
    
    // Fill in the form field
    document.getElementById('editRemaining').value = remaining;
    
    modal.show();
}

function promptAddOilChanges() {
    const modal = new bootstrap.Modal(document.getElementById('addOilChangesModal'));
    
    // Reset form values
    document.getElementById('addQuantity').value = '4';
    document.getElementById('addReason').value = '';
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('addServiceDate').value = today;
    
    modal.show();
}

document.addEventListener('DOMContentLoaded', function() {
    // Check if there's an error parameter in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    if (error) {
        // Show error in modal
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        document.getElementById('errorModalBody').textContent = decodeURIComponent(error);
        errorModal.show();
        // Clean up the URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Add form submission handler for mileage validation
    document.getElementById('useOilChangeForm').addEventListener('submit', function(e) {
        const mileageInput = document.getElementById('useMileage');
        const currentMileage = parseInt(mileageInput.value);
        const lastMileage = parseInt(mileageInput.getAttribute('data-last-mileage'));
        
        if (currentMileage && lastMileage && currentMileage < lastMileage) {
            e.preventDefault();
            if (confirm(`Warning: Current mileage (${currentMileage}) is less than previous mileage (${lastMileage}). Are you sure this is correct?`)) {
                // Remove the event listener and submit again
                this.removeEventListener('submit', arguments.callee);
                this.submit();
            }
        }
    });
});

// Inline ledger editing
function enterLedgerEdit(id) {
  const row = document.getElementById(`ledger_row_${id}`);
  if (!row || row.classList.contains('editing')) return;
  row.classList.add('editing');
  const dateCell = row.querySelector('.ledger-date');
  const mileageCell = row.querySelector('.ledger-mileage');
  const noteCell = row.querySelector('.ledger-note');
  const actionsCell = row.querySelector('.ledger-actions');
  const dateValue = dateCell.getAttribute('data-value') || '';
  const mileageValue = mileageCell.getAttribute('data-value') || '';
  const noteValue = noteCell.getAttribute('data-value') || '';
  dateCell.innerHTML = `<input type="date" class="form-control form-control-sm" value="${dateValue}">`;
  mileageCell.innerHTML = `<input type="number" class="form-control form-control-sm" value="${mileageValue}" style="width:100px">`;
  noteCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${noteValue}" maxlength="255">`;
  actionsCell.innerHTML = `
    <button class="btn btn-sm btn-primary me-1" onclick="saveLedgerEdit(${id})">Save</button>
    <button class="btn btn-sm btn-secondary" onclick="cancelLedgerEdit(${id})">Cancel</button>
  `;
}

function cancelLedgerEdit(id) {
  const row = document.getElementById(`ledger_row_${id}`);
  if (!row) return;
  row.classList.remove('editing');
  // Re-fetch JSON to restore canonical view
  fetch(`/ui/customer/{{ c.id }}/ledger/${id}/json`).then(r=>r.json()).then(data => {
    if (data.error) return;
    const dateCell = row.querySelector('.ledger-date');
    const mileageCell = row.querySelector('.ledger-mileage');
    const noteCell = row.querySelector('.ledger-note');
    const actionsCell = row.querySelector('.ledger-actions');
    dateCell.setAttribute('data-value', data.date || '');
    dateCell.textContent = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';
    mileageCell.setAttribute('data-value', data.mileage || '');
    mileageCell.textContent = data.mileage || '';
    noteCell.setAttribute('data-value', data.note || '');
    noteCell.textContent = data.note || '';
    actionsCell.innerHTML = `
      <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="enterLedgerEdit(${id})">Edit</button>
      <form method="post" action="/ui/customer/{{ c.id }}/ledger/${id}/delete" class="d-inline" onsubmit="return confirm('Are you sure you want to remove this entry? This will ${data.delta < 0 ? 'add back' : 'remove'} ${Math.abs(data.delta)} oil change${Math.abs(data.delta) !== 1 ? 's' : ''}.')">
        <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
      </form>`;
  });
}

async function saveLedgerEdit(id) {
  const row = document.getElementById(`ledger_row_${id}`);
  if (!row) return;
  const dateInput = row.querySelector('.ledger-date input');
  const mileageInput = row.querySelector('.ledger-mileage input');
  const noteInput = row.querySelector('.ledger-note input');
  const formData = new FormData();
  if (mileageInput.value) formData.append('mileage', mileageInput.value);
  if (dateInput.value) formData.append('service_date', dateInput.value);
  formData.append('note', noteInput.value);
  const resp = await fetch(`/ui/customer/{{ c.id }}/ledger/${id}/edit-json`, { method: 'POST', body: formData });
  const data = await resp.json();
  if (!data.success) { alert(data.error || 'Failed to save'); return; }
  // Update row
  row.classList.remove('editing');
  const dateCell = row.querySelector('.ledger-date');
  const mileageCell = row.querySelector('.ledger-mileage');
  const noteCell = row.querySelector('.ledger-note');
  const actionsCell = row.querySelector('.ledger-actions');
  dateCell.setAttribute('data-value', data.entry.date || '');
  dateCell.textContent = data.entry.date ? new Date(data.entry.date).toLocaleDateString() : 'N/A';
  mileageCell.setAttribute('data-value', data.entry.mileage || '');
  mileageCell.textContent = data.entry.mileage || '';
  noteCell.setAttribute('data-value', data.entry.note || '');
  noteCell.textContent = data.entry.note || '';
  actionsCell.innerHTML = `
    <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="enterLedgerEdit(${id})">Edit</button>
    <form method="post" action="/ui/customer/{{ c.id }}/ledger/${id}/delete" class="d-inline" onsubmit="return confirm('Are you sure you want to remove this entry? This will ${data.entry.delta < 0 ? 'add back' : 'remove'} ${Math.abs(data.entry.delta)} oil change${Math.abs(data.entry.delta) !== 1 ? 's' : ''}.')">
      <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
    </form>`;
}

// Delegated click handling for ledger edit buttons
document.addEventListener('click', function(ev){
  const btn = ev.target.closest('.ledger-edit-btn');
  if (btn) {
    const id = btn.getAttribute('data-entry-id');
    if (id) enterLedgerEdit(id);
  }
});

function openUseOilChangeModal(vehicleId, vehicleInfo, lastMileage) {
    document.getElementById('useVehicleId').value = vehicleId;
    document.getElementById('useVehicleInfo').value = vehicleInfo;
    document.getElementById('useMileage').value = '';
    document.getElementById('useServiceDate').value = '{{ today_date }}';
    
    // Store last mileage for validation
    document.getElementById('useMileage').setAttribute('data-last-mileage', lastMileage || 0);
    
    const modal = new bootstrap.Modal(document.getElementById('useOilChangeModal'));
    modal.show();
    
    // Auto-focus on mileage input after modal is shown
    document.getElementById('useOilChangeModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('useMileage').focus();
    }, { once: true });
}

function openAddFourModal(vehicleId, vehicleInfo) {
    document.getElementById('addFourVehicleId').value = vehicleId;
    document.getElementById('addFourVehicleInfo').value = vehicleInfo;
    document.getElementById('addFourServiceDate').value = '{{ today_date }}';
    
    const modal = new bootstrap.Modal(document.getElementById('addFourModal'));
    modal.show();
    
    // Auto-focus on date input after modal is shown
    document.getElementById('addFourModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('addFourServiceDate').focus();
    }, { once: true });
}

function validateMileage(input) {
    const currentMileage = parseInt(input.value);
    const lastMileage = parseInt(input.getAttribute('data-last-mileage'));
    const warningDiv = document.getElementById('mileageWarning');
    
    if (currentMileage && lastMileage && currentMileage < lastMileage) {
        warningDiv.style.display = 'block';
        input.classList.add('border-warning');
    } else {
        warningDiv.style.display = 'none';
        input.classList.remove('border-warning');
    }
}

function submitUseOilChange(vehicleId) {
    const mileage = document.getElementById('mileage_' + vehicleId).value;
    const serviceDate = document.getElementById('service_date_' + vehicleId).value;
    
    if (!mileage) {
        alert('Mileage is required for using an oil change.');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = '/ui/customer/{{ c.id }}/deduct';
    
    form.innerHTML = `
        <input type="hidden" name="vehicle_id" value="${vehicleId}">
        <input type="hidden" name="mileage" value="${mileage}">
        <input type="hidden" name="service_date" value="${serviceDate}">
    `;
    
    document.body.appendChild(form);
    form.submit();
}

function submitAddFour(vehicleId) {
    const serviceDate = document.getElementById('service_date_' + vehicleId).value;
    
    const form = document.createElement('form');
    form.method = 'post';
    form.action = '/ui/customer/{{ c.id }}/add-four';
    
    form.innerHTML = `
        <input type="hidden" name="vehicle_id" value="${vehicleId}">
        <input type="hidden" name="service_date" value="${serviceDate}">
    `;
    
    document.body.appendChild(form);
    form.submit();
}

// VIN Lookup Functions
async function lookupVinForAdd() {
    const vinInput = document.getElementById('addVin');
    const vin = vinInput.value.trim();
    
    if (!vin) {
        alert('Please enter a VIN first');
        return;
    }
    
    if (vin.length < 11) {
        alert('VIN must be at least 11 characters');
        return;
    }
    
    try {
        const button = event.target;
        button.disabled = true;
        button.textContent = '‚è≥';
        
        const response = await fetch(`/vehicles/lookup-vin/${encodeURIComponent(vin)}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // Populate the form fields
            if (data.year) document.getElementById('addYear').value = data.year;
            if (data.make) document.getElementById('addMake').value = data.make;
            if (data.model) document.getElementById('addModel').value = data.model;
            
            if (data._learned) {
                alert('Vehicle information populated from VIN!\n\nOil specifications loaded from previous entries with this VIN.');
            } else {
                alert('Vehicle information populated from VIN!');
            }
        } else {
            alert('Could not find vehicle information for this VIN');
        }
    } catch (error) {
        console.error('VIN lookup error:', error);
        alert('Error looking up VIN. Please try again.');
    } finally {
        const button = event.target;
        button.disabled = false;
        button.textContent = 'üîç';
    }
}

async function lookupVinForEdit() {
    const vinInput = document.getElementById('editVin');
    const vin = vinInput.value.trim();
    
    if (!vin) {
        alert('Please enter a VIN first');
        return;
    }
    
    if (vin.length < 11) {
        alert('VIN must be at least 11 characters');
        return;
    }
    
    try {
        const button = event.target;
        button.disabled = true;
        button.textContent = '‚è≥ Lookup';
        
        const response = await fetch(`/vehicles/lookup-vin/${encodeURIComponent(vin)}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // Populate the form fields
            if (data.year) document.getElementById('editYear').value = data.year;
            if (data.make) document.getElementById('editMake').value = data.make;
            if (data.model) document.getElementById('editModel').value = data.model;
            if (data.oil_weight) document.getElementById('editOilWeight').value = data.oil_weight;
            if (data.oil_capacity_quarts) document.getElementById('editOilCapacity').value = data.oil_capacity_quarts;
            
            if (data._learned) {
                alert('Vehicle information populated from VIN!\n\nOil specifications loaded from previous entries with this VIN.');
            } else {
                alert('Vehicle information populated from VIN!');
            }
        } else {
            alert('Could not find vehicle information for this VIN');
        }
    } catch (error) {
        console.error('VIN lookup error:', error);
        alert('Error looking up VIN. Please try again.');
    } finally {
        const button = event.target;
        button.disabled = false;
        button.textContent = 'üîç Lookup';
    }
}

// Mileage confirmation functionality
let pendingMileageData = {};

function confirmMileage() {
    // Add the confirmation flag and submit the form
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/ui/customer/{{ c.id }}/deduct`;
    form.style.display = 'none';
    
    form.innerHTML = `
        <input type="hidden" name="vehicle_id" value="${pendingMileageData.vehicle_id}">
        <input type="hidden" name="mileage" value="${pendingMileageData.mileage}">
        <input type="hidden" name="service_date" value="${pendingMileageData.service_date}">
        <input type="hidden" name="confirm_mileage" value="true">
    `;
    
    document.body.appendChild(form);
    form.submit();
}

// Check for mileage confirmation on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const showConfirm = urlParams.get('show_confirm');
    const error = urlParams.get('error');
    
    if (showConfirm === 'true' && error) {
        // Store the pending data
        pendingMileageData.vehicle_id = urlParams.get('vehicle_id');
        pendingMileageData.mileage = urlParams.get('mileage');
        pendingMileageData.service_date = urlParams.get('service_date');
        
        // Show the confirmation modal
        document.getElementById('mileageConfirmModalBody').innerHTML = decodeURIComponent(error.replace(/\+/g, ' '));
        const modal = new bootstrap.Modal(document.getElementById('mileageConfirmModal'));
        modal.show();
        
        // Clean up the URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
});

</script>
{% endblock %}
